/*   

Mixtool Â© 2012 by Jamie Perkins
http://inorganik.net

FUNCTION INDEX

buildKeySelect()
setKeyPref(pref)
readKeyPref()
findMatches(key)
textKeyMatches(key)
findAllMatches(type)
detectHarmonic(type)
reOrderTracks()
reverseTracks()
randomize()
makeToken()
newMix()
save(boo)
copy()
printMix()
deleteMix(mixToken)
makeButton(mixToken)
loadMix(mixToken)
loadAll()
addTrack()
removeTrack()
searchTrack()
selectKey()
help()

*/function buildKeySelect(){var a=keyMode==1?traditionalKeys.concat():camelotKeys.concat();$(a).each(function(b){$("select[name=key]").append('<option value="'+b+'">'+a[b]+"</option>")})}function setKeyPref(a){var b="keyPref",c=new Date;c.setTime(c.getTime()+31536e7);var d="; expires="+c.toGMTString();document.cookie=b+"="+a+";expires="+d+"; path=/";$("button").removeClass("keyPref");a==1?$("button.tradKeys").addClass("keyPref"):$("button.camKeys").addClass("keyPref");keyMode=a;var e=$("input[name=mixTitle]").val();e&&save(!1);window.location.reload()}function readKeyPref(){var a=keyMode,b="keyPref",c=document.cookie.split(";");for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)==" ")e=e.substring(1,e.length);if(e.indexOf(b)==0){var f=e.indexOf("=");a=e.substring(f+1,e.length);keyMode=a}}a==1?$("button.tradKeys").addClass("keyPref"):$("button.camKeys").addClass("keyPref");buildKeySelect()}function findMatches(a){a=Number(a);var b=a,c=a;if(a>11){a==12?b=23:b--;a==23?c=12:c++;var d=a-12}else{a==0?b=11:b--;a==11?c=0:c++;var d=a+12}var e=[];e[0]=a;e[1]=b;e[2]=c;e[3]=d;return e}function textKeyMatches(a){var b=findMatches(a),c=[];$(b).each(function(a){c[a]=keyMode==1?traditionalKeys[b[a]]:camelotKeys[b[a]]});c=c.join(", ");return c}function findAllMatches(a){var b=[],c=[];$("ol li").each(function(d){var e=a=="print"?$(this).children("input[name=key]").val():$(this).find("select").val();if(e){b[d]=e;c[d]=findMatches(e)}});var d=[];$(b).each(function(a){var e=[];$(c).each(function(d){d!=a&&$(c[d]).each(function(c){this==b[a]&&e.push(Number(d))})});d[a]=e});var e=[];$(d).each(function(a){d[a].sort(function(a,b){return d[b].length-d[a].length})});return d}function detectHarmonic(a){var b=a=="print"?findAllMatches("print"):findAllMatches(0),c=[];$("ol li").children(".harmonic").css({display:"none"});$("ol li").each(function(d){var e=d-1;if(d>0){$(b[e]).each(function(a){if(this==d){$("ol li").eq(e).children(".harmonic").css({display:"block"});c.push(1)}});var f=a=="print"?$("ol li").eq(e).children("input[name=key]").val():$("ol li").eq(e).find("select").val(),g=a=="print"?$(this).children("input[name=key]").val():$(this).find("select").val(),h=findMatches(f),i;if(f){$(h).each(function(a){if(this==g){a==0&&(i="same key");a==1&&(i="key down");a==2&&(i="key up");a==3&&(f>11?i="minor-major":"major-minor")}});a=="print"&&(i='<img src="../_images/mixPrint.gif"><span>'+i+"</span>");$("ol li").eq(e).children(".harmonic").html(i)}}});$(".numHarmonic").html(c.length+(c.length==1?" harmonic mix":" harmonic mixes"));return c.length}function reOrderTracks(){var a=[],b=[],c=[];$("ol.tracklist li").each(function(d){a.push($("ol.tracklist li").eq(d).find("input[name=track]").val());var e=$("ol.tracklist li").eq(d).find("select").val();if(!e){alert("Please select a key for each track.");return!1}b.push(e);c.push(d)});var d=findAllMatches(!0),e=d.concat(),f=[],g=999,h=999;$(e).each(function(a){var b=999;$(e).each(function(a){if(e[a].length<1){b=a;f.push(c[a]);return!1}});if(b<999){e.splice(b,1);c.splice(b,1)}});$(e).each(function(a){var b=999;$(e).each(function(a){if(h<999){$(e[a]).each(function(d){if(this==h){b=a;f.push(c[a]);h=999;return!1}});if(b<999)return!1}else if(e[a].length==1&&d[e[a]].length==1){b=a;f.push(c[a]);h=c[a];return!1}});if(b<999){e.splice(b,1);c.splice(b,1)}});$(e).each(function(a){var b=999;$(e).each(function(a){if(g<999){$(e[a]).each(function(d){if(this==g){b=a;f.push(c[a]);g=c[a];return!1}});if(b<999)return!1}else if(e[a].length==1&&d[e[a]].length>1){b=a;f.push(c[a]);g=c[a];return!1}});if(b<999){e.splice(b,1);c.splice(b,1)}else{var h=999;$(e).each(function(a){if(this.length<h){h=this.length;b=a}});f.push(c[b]);g=c[b];e.splice(b,1);c.splice(b,1)}});c.length>0&&alert("did not build all tracks. ("+c+")");$("ol.tracklist").html('<li class="firstItem">'+trackli+"</li>");$(f).each(function(c){c>0&&$("ol.tracklist").append("<li>"+trackli+"</li>");$("ol.tracklist li").eq(c).find("input[name=track]").val(a[f[c]]);$("ol.tracklist li").eq(c).find("select").val(b[f[c]]);$("ol.tracklist li").eq(c).find("input[name=mixable]").val(textKeyMatches(b[f[c]]))});detectHarmonic(0)}function reverseTracks(){var a=[],b=[],c=[];$("ol.tracklist li").each(function(d){a.push($("ol.tracklist li").eq(d).find("input[name=track]").val());b.push($("ol.tracklist li").eq(d).find("select").val());c.push(d)});c.reverse();$("ol.tracklist").html('<li class="firstItem">'+trackli+"</li>");$(c).each(function(d){d>0&&$("ol.tracklist").append("<li>"+trackli+"</li>");$("ol.tracklist li").eq(d).find("input[name=track]").val(a[c[d]]);$("ol.tracklist li").eq(d).find("select").val(b[c[d]]);$("ol.tracklist li").eq(d).find("input[name=mixable]").val(textKeyMatches(b[c[d]]))});detectHarmonic(0)}function randomize(){var a=[],b=[],c=[];$("ol.tracklist li").each(function(d){a.push($("ol.tracklist li").eq(d).find("input[name=track]").val());b.push($("ol.tracklist li").eq(d).find("select").val());c.push(d)});c.sort(function(){return.5-Math.random()});$("ol.tracklist").html('<li class="firstItem">'+trackli+"</li>");$(c).each(function(d){d>0&&$("ol.tracklist").append("<li>"+trackli+"</li>");$("ol.tracklist li").eq(d).find("input[name=track]").val(a[c[d]]);$("ol.tracklist li").eq(d).find("select").val(b[c[d]]);$("ol.tracklist li").eq(d).find("input[name=mixable]").val(textKeyMatches(b[c[d]]))});detectHarmonic(0)}function makeToken(){var a="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",b="";for(i=0;i<16;i++)b+=a[Math.round(Math.random()*51)];return b}function newMix(){$("input[name=mixTitle]").val("");$("ol.tracklist").html('<li class="firstItem">'+trackli+"</li>");$("button.mix").removeClass("active");$(".numHarmonic").html("");activeMix=makeToken()}function save(a){var b=escape($("input[name=mixTitle]").val());if(!b){alert("Please enter a title for the mix.");return!1}var c="mixtool."+activeMix,c="mixtool."+activeMix,d=document.cookie.split(";");for(var e=0;e<d.length;e++){var f=d[e];while(f.charAt(0)==" ")f=f.substring(1,f.length);if(f.indexOf(c)==0){var g=new Date;g.setTime(g.getTime()+ -864e5);var h="; expires="+g.toGMTString();document.cookie=c+"="+""+";expires="+h+"; path=/"}}var i=[b];$("ol.tracklist li").each(function(a){var b=$(this).find("input[name=track]").val(),c=a+1;b||(b="track "+c);var d=b+"\\"+$(this).find("select").val();i.push(d)});var g=new Date;g.setTime(g.getTime()+31536e7);var h="; expires="+g.toGMTString();document.cookie=c+"="+i+";expires="+h+"; path=/";$("button.delete").remove();var j='<button class="file delete" onClick="deleteMix()">delete</button>';$(j).insertAfter("button[name=hiddenSave]");a&&alert('Saved\n"'+unescape(b)+'"');loadAll()}function copy(){activeMix=makeToken();var a=$("input[name=mixTitle]").val();a+=" copy";$("input[name=mixTitle]").val(a);save(!1)}function printMix(){var a=$("input[name=mixTitle]").val(),b="print/?p="+activeMix,c=window.open(b,a);c.focus()}function deleteMix(){var a=$("input[name=mixTitle]").val();if(confirm('Are you sure you want to delete "'+a+'"?')){var b="mixtool."+activeMix,c=document.cookie.split(";");for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)==" ")e=e.substring(1,e.length);if(e.indexOf(b)==0){var f=new Date;f.setTime(f.getTime()+ -864e5);var g="; expires="+f.toGMTString();document.cookie=b+"="+""+";expires="+g+"; path=/";$("#"+activeMix).remove()}}$("input[name=mixTitle]").val("");$("ol.tracklist").html('<li class="firstItem">'+trackli+"</li>")}}function makeButton(a){var b="mixtool."+a,c=document.cookie.split(";");for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)==" ")e=e.substring(1,e.length);if(e.indexOf(b)==0){var f=e.indexOf("="),g=e.substring(8,24),h=e.substring(f+1,e.length);h=h.split(",");var i=h[0],j='<button class="mix" id="'+a+'"';j+="onClick=\"loadMix('"+a+"')\">";var k=unescape(i);j+=k+"</button>";return j}}}function loadMix(a){var b="mixtool."+a;$("button.mix").removeClass("active");$("#"+a).addClass("active");var c=document.cookie.split(";");$("ol.tracklist").html('<li class="firstItem">'+trackli+"</li>");for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)==" ")e=e.substring(1,e.length);if(e.indexOf(b)==0){var f=e.indexOf("="),g=e.substring(8,24);$("button.delete").remove();var h='<button class="file delete" onClick="deleteMix()">delete</button>';$(h).insertAfter("button[name=hiddenSave]");var i=e.substring(f+1,e.length);i=i.split(",");$("input[name=mixTitle]").val(unescape(i[0]));$(i).each(function(a){if(a>0){a>1&&$("ol.tracklist").append("<li>"+trackli+"</li>");var b=i[a].split("\\");$("ol.tracklist li").eq(a-1).find("input[name=track]").val(b[0]);$("ol.tracklist li").eq(a-1).find("select").val(b[1]);$("ol.tracklist li").eq(a-1).find("input[name=mixable]").val(textKeyMatches(b[1]))}});detectHarmonic(0);activeMix=a}}}function loadAll(){var a="mixtool.",b=document.cookie.split(";"),c="",d=[];for(var e=0;e<b.length;e++){var f=b[e];while(f.charAt(0)==" ")f=f.substring(1,f.length);f.indexOf(a)==0&&d.push(f.substring(8,24))}if(d.length>0){d.reverse();$(d).each(function(a){c+=makeButton(d[a])});$("#mixes").html(c);$("#mixes").css({display:"block"});loadMix(d[0])}else{activeMix=makeToken();$("#firstVisit").show()}}function addTrack(){$("<li>"+trackli+"</li>").insertAfter($(this).parent());detectHarmonic(0)}function removeTrack(){$(this).parent().remove();$("ol.tracklist li").length>1?$('ol.tracklist li:not(:has("a.removeTrack"))').append('<a class="trackCount removeTrack">&ndash;</a>'):$("ol.tracklist li:first a.removeTrack").remove();detectHarmonic(0)}function searchTrack(){var a="http://beatport.com/search?query=",b=$(this).parent().find("input[name=track]").val();b=b.replace(/-/g,"");b=b.replace(/ /g,"+");b=b.replace("++","+");a+=b;var c=window.open(a,"beatport");c.focus()}function selectKey(){var a=textKeyMatches($(this).val());$(this).next().val(a);detectHarmonic(0)}function activeMix(){$("button.mix").removeClass("active");$(this).addClass("active")}function help(){$("#help").slideToggle("fast")}function hideWelcome(){$("#firstVisit").slideToggle("fast")}var trackli,keyMode=1,traditionalKeys=["E major","B major","F-sharp major","D-flat major","A-flat major","E-flat major","B-flat major","F major","C major","G major","D major","A major","d-flat minor","a-flat minor","e-flat minor","b-flat minor","f minor","c minor","g minor","d minor","a minor","e minor","b minor","f-sharp minor"],camelotKeys=["12B","1B","2B","3B","4B","5B","6B","7B","8B","9B","10B","11B","12A","1A","2A","3A","4A","5A","6A","7A","8A","9A","10A","11A"],activeMix=makeToken();